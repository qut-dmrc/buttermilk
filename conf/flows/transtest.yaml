# defaults:
#   - _self_

trans:
  _target_: buttermilk.runner.flow.Flow
  source: trans journalists guidelines test
  data:
    - name: tja_train
      type: file
      path: gs://prosocial-dev/data/tja_train.jsonl
      index: 
        - record_id

  steps:
    - name: context
      _target_: buttermilk.agents.lc.LC
      num_runs: 1
      save: ${save}
      parameters: 
        template: context
        model: ${llm}
      inputs:
        record: record
      outputs:
        feedback:
          - text: outputs.description
            id: identifier

    - name: judger
      _target_: buttermilk.agents.lc.LC
      num_runs: 1
      save: ${save}
      parameters: 
        template: judge
        criteria: trans_factored
        formatting: json_rules
        model: ${llm}
      inputs:
        record: record
      outputs:
        answer:
          - identifier: identifier
            record_id: record.record_id
            job_id: job_id
            answer: outputs
            model: parameters.model
            criteria: parameters.criteria
            template: parameters.template
      
    - name: synth
      _target_: buttermilk.agents.lc.LC
      num_runs: 1
      save: ${save}
      parameters:
        template: synthesise_judger
        instructions: judge
        criteria: trans_simplified
        formatting: json_rules
        model: ${llm}
      inputs:
        record: record
        answers: judger.answer
        feedback: context.feedback

      outputs:
        answer:
          identifier: identifier
          record_id: record.record_id
          job_id: job_id
          answer: outputs
          model: parameters.model
          criteria: parameters.criteria
          template: parameters.template
    
    - name: scorer
      _target_: buttermilk.agents.lc.LC
      num_runs: 1
      save: ${save}
      parameters:
        template: evaluate
        model: ${llm}
        answer:
          - judger.answer
          - synth.answer
        expected: record.ground_truth
      outputs:
        job_id: scorer.job_id
        score: outputs.score
        score_llm: scorer.parameters.model
        reasons: outputs.reasons
        
    - name: eval 
      _target_: buttermilk.agents.lc.LC
      num_runs: 1
      save: ${save}
      parameters:
        template: differences
        criteria: 
          - trans_simplified
        model: ${llm}
      inputs:
        content: record.text
        answers:
          - judger.outputs
          - synth.outputs
      outputs:
        differences: outputs
        judge: inputs.answers.model
        criteria: input.answers.criteria
        template: input.answers.template

    - name: export
      _target_: buttermilk.agents.sheetexporter.GSheetExporter
      convert_json_columns:
        - answers
        - synthesis
        - differences
        - analysis
      save:
        type: gsheets
        sheet_name: evals
        title: Trans Guidelines Judger
      inputs:
        flow_id: flow_id
        job_id: job_id
        timestamp: timestamp
        models:
          - judger.model
          - synth.model
          - eval.model
        criteria: 
          - judger.criteria
          - synth.criteria
        template: 
          - judger.template
          - synth.template
        record: record
        answers:
          - judger.answer
        context:
          - context.feedback
        synthesis:
          - synth.answer
        differences:
          - differences: eval.differences
            model: eval.model
